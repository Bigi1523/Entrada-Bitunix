<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Bitunix — iPhone</title>
<style>
  :root{
    --bg1:#071022;
    --bg2:#0b1630;
    --panel:rgba(255,255,255,.06);
    --panel2:rgba(255,255,255,.045);
    --border:rgba(255,255,255,.10);
    --text:#e7eefc;
    --muted:rgba(231,238,252,.65);

    --longOn:rgba(22,163,74,.22);
    --shortOn:rgba(220,38,38,.18);

    --ok:#22c55e;
    --bad:#ef4444;

    --shadow: 0 10px 25px rgba(0,0,0,.35);
    --radius:18px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    color:var(--text);

    background:
      radial-gradient(900px 520px at 50% -15%, rgba(56,189,248,.08), transparent 62%),
      radial-gradient(900px 620px at 85% 15%, rgba(34,197,94,.05), transparent 68%),
      radial-gradient(900px 720px at 15% 95%, rgba(239,68,68,.04), transparent 72%),
      linear-gradient(160deg, #050a14, #070f22 45%, #060b18 100%);
    padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px;
  }

  .wrap{max-width:740px;margin:10px auto 18px auto}

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.055), rgba(255,255,255,.035));
    border:1px solid rgba(255,255,255,.10);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding:14px;
    backdrop-filter: blur(8px);
  }

  .sectionLabel{
    font-size:13px;
    color:var(--muted);
    margin:2px 0 10px 2px;
    letter-spacing:.2px;
  }

  .segRow{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    margin-bottom:12px;
  }

  .segBtn{
    border-radius:16px;
    padding:12px 12px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.30);
    color:rgba(231,238,252,.92);
    font-weight:900;
    font-size:18px;
    text-align:center;
    user-select:none;
    transition:transform .06s ease, filter .15s ease, background .15s ease, border-color .15s ease;
  }
  .segBtn:active{transform:scale(.99)}
/* ===== Short/Long INACTIVO = gris (no rojo/verde) ===== */
.segBtn.short,
.segBtn.long{
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.30));
  border-color: rgba(255,255,255,.14);
  color: rgba(231,238,252,.88);
}

/* ===== ACTIVO = mantiene color claro y borde fuerte ===== */
.segBtn.short.on{
  background: linear-gradient(180deg, rgba(220,38,38,.62), rgba(0,0,0,.28));
  border-color: rgba(239,68,68,.95);
  box-shadow:
    0 0 0 2px rgba(239,68,68,.20) inset,
    0 12px 26px rgba(239,68,68,.14);
}

.segBtn.long.on{
  background: linear-gradient(180deg, rgba(22,163,74,.62), rgba(0,0,0,.28));
  border-color: rgba(34,197,94,.95);
  box-shadow:
    0 0 0 2px rgba(34,197,94,.20) inset,
    0 12px 26px rgba(34,197,94,.14);
}

  .segBtn.on{filter:brightness(1.08)}

  .segBtn.strategy{font-size:16px;font-weight:950}
  .segBtn.strategy.on{
    background: rgba(56,189,248,.16);
    border-color: rgba(56,189,248,.42);
    box-shadow: 0 0 0 2px rgba(56,189,248,.10) inset;
  }

  .sideBanner{
    border-radius:16px;
    border:1px solid rgba(255,255,255,.10);
    padding:10px 12px;
    font-weight:950;
    letter-spacing:.2px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    margin: 2px 0 14px 0;
    user-select:none;
  }
  .sideBanner.short{
    background: linear-gradient(180deg, rgba(220,38,38,.18), rgba(0,0,0,.22));
    border-color: rgba(239,68,68,.35);
    box-shadow: 0 0 0 2px rgba(239,68,68,.10) inset;
  }
  .sideBanner.long{
    background: linear-gradient(180deg, rgba(22,163,74,.18), rgba(0,0,0,.22));
    border-color: rgba(34,197,94,.35);
    box-shadow: 0 0 0 2px rgba(34,197,94,.10) inset;
  }
  .sideBanner .ico{font-size:16px; opacity:.95}
  .sideBanner .txt{font-size:14px; color:rgba(231,238,252,.92)}

  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}

  .lab{
    font-size:12px;
    color:var(--muted);
    margin:0 0 6px 2px;
  }
  input{
    width:100%;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.08);
    background: rgba(0,0,0,.30);
    color:rgba(231,238,252,.95);
    padding:12px 12px;
    font-size:18px;
    outline:none;
  }
  input::placeholder{color:rgba(231,238,252,.35)}
  input:focus{border-color: rgba(56,189,248,.45); box-shadow:0 0 0 3px rgba(56,189,248,.14)}
  input.invalid{
    border-color: rgba(239,68,68,.55) !important;
    box-shadow: 0 0 0 3px rgba(239,68,68,.18) !important;
  }

  .btnRow{
    display:grid;
    grid-template-columns: 1fr 110px;
    gap:10px;
    margin:12px 0 10px 0;
    align-items:center;
  }
  .btnPrimary, .btnGhost{
    border-radius:18px;
    padding:14px 14px;
    border:1px solid rgba(255,255,255,.12);
    font-weight:950;
    font-size:20px;
    cursor:pointer;
  }
  .btnPrimary{
    background: linear-gradient(135deg, rgba(56,189,248,.95), rgba(14,165,233,.95));
    color:#06101e;
    border:none;
  }
  .btnGhost{
    background: rgba(0,0,0,.28);
    color:rgba(231,238,252,.92);
  }
  .btnGhost:active, .btnPrimary:active{transform:scale(.99)}

  .pillRow{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin:10px 0 12px 0;
  }
  .pill{
    background: rgba(0,0,0,.26);
    border:1px solid rgba(255,255,255,.08);
    color: rgba(231,238,252,.82);
    padding:8px 10px;
    border-radius:999px;
    font-weight:800;
    font-size:14px;
  }
  .pill.preview{border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10)}
  .pill.ok{border-color: rgba(34,197,94,.30); background: rgba(34,197,94,.10)}

  .tableWrap{
    margin-top:10px;
    overflow-x:auto;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.07);
    background: rgba(0,0,0,.20);
  }
  table{
    width:100%;
    border-collapse:collapse;
    min-width: 0;
  }
  th,td{
    padding:8px 10px;
    border-bottom:1px solid rgba(255,255,255,.07);
    font-size:13px;
    color: rgba(231,238,252,.90);
    vertical-align:middle;
    white-space:nowrap;
  }
  th{color:rgba(231,238,252,.55); font-weight:900}
  td.r, th.r{text-align:right}
  tr:last-child td{border-bottom:none}
  tr.preview td{opacity:.78; font-style:italic}

  .actions{
    display:flex; gap:8px; justify-content:flex-end; align-items:center;
  }
  .miniBtn{
    border-radius:12px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.24);
    color: rgba(231,238,252,.92);
    padding:7px 10px;
    font-weight:950;
    cursor:pointer;
  }

  .tpRow{
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap:10px;
    margin-top:10px;
  }

  .hintUnder{
    margin:10px 2px 0 2px;
    color: rgba(231,238,252,.65);
    font-size:14px;
    font-weight:800;
  }

  .kpiGrid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
    margin-top:12px;
  }
  .kpi{
    background: rgba(0,0,0,.24);
    border:1px solid rgba(255,255,255,.08);
    border-radius:18px;
    padding:12px 12px;
  }
  .kpi .t{font-size:13px;color:rgba(231,238,252,.62);font-weight:850}
  .kpi .v{margin-top:6px;font-size:24px;font-weight:950;letter-spacing:.2px}
  .kpi .v.small{font-size:18px;font-weight:950}
  .up{color:var(--ok)}
  .down{color:var(--bad)}
  .muted{color:var(--muted)}

  .toast{
    margin-top:10px;
    min-height:18px;
    font-size:13px;
    font-weight:800;
    color: rgba(167,243,208,.95);
  }

  .note{
    margin-top:10px;
    font-size:13px;
    color: rgba(231,238,252,.62);
    line-height:1.35;
  }

  .subLine{
    margin-top:10px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    color:rgba(231,238,252,.70);
    font-size:14px;
    font-weight:900;
  }
  .subPill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.08);
    background: rgba(0,0,0,.22);
  }
  .copyIco{
    opacity:.65;
    font-size:14px;
    line-height:1;
    cursor:pointer;
    user-select:none;
  }
  .copyIco:active{transform:scale(.98)}
  .pctTag{
    margin-left:8px;
    color: rgba(56,189,248,.95);
    font-weight:950;
  }

  @media (max-width: 480px){
    th,td{font-size:12px; padding:8px 8px;}
    .miniBtn{padding:7px 9px; font-size:12px;}
    .col-qty{display:none;}
  }

  @media (max-width:390px){
    input{font-size:17px}
    .btnPrimary{font-size:19px}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">

    <!-- ===== ARRIBA: ENTRADAS ===== -->
    <div class="grid3">
      <div>
        <div class="lab">Entrada</div>
        <input id="inPrice" inputmode="decimal" placeholder="Ej: 223.59" />
      </div>
      <div>
        <div class="lab">Lev (x)</div>
        <input id="inLev" inputmode="decimal" value="30" />
      </div>
      <div>
        <div class="lab">Margen</div>
        <input id="inMargin" inputmode="decimal" value="50" />
      </div>
    </div>

    <div class="btnRow">
      <button id="btnAdd" class="btnPrimary">Añadir entrada</button>
      <button id="btnReset" class="btnGhost">Reset</button>
    </div>

    <div class="pillRow">
      <div class="pill" id="pillMargin">Margin total: —</div>
      <div class="pill" id="pillQty">Qty total: —</div>
      <div class="pill ok" id="pillMode">Modo: —</div>
    </div>

    <!-- ===== ARRIBA: TABLA ===== -->
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th class="r">Precio</th>
            <th class="r">Lev</th>
            <th class="r col-margin">Margen</th>
            <th class="r col-qty">Qty</th>
            <th class="r">Acciones</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <!-- ===== ARRIBA: CIERRES ===== -->
    <div class="tpRow">
      <div>
        <div class="lab">Cierre parcial</div>
        <input id="tp1Price" inputmode="decimal" placeholder="vacío = % estrategia" />
      </div>
      <div>
        <div class="lab">Stop Loss</div>
        <input id="slPrice" inputmode="decimal" placeholder="vacío = % estrategia" />
      </div>
      <div>
        <div class="lab">Cierre final</div>
        <input id="tp2Price" inputmode="decimal" placeholder="vacío = no calculado" />
      </div>
    </div>

    <!-- ===== LUEGO: ESTRATEGIA + LADO + BANNER ===== -->
    <div class="sectionLabel" style="margin-top:14px">Estrategia</div>
    <div class="segRow" style="margin-bottom:12px">
      <div id="btnEma" class="segBtn strategy on">EMA8</div>
      <div id="btnBol" class="segBtn strategy">Bollinger</div>
    </div>

    <div class="sectionLabel" style="margin-top:2px">Lado</div>
    <div class="segRow" style="margin-bottom:10px">
      <div id="btnShort" class="segBtn short on">Short</div>
      <div id="btnLong"  class="segBtn long">Long</div>
    </div>

    <div id="sideBanner" class="sideBanner short">
      <span class="ico" id="sideBannerIco" aria-hidden="true">⚠️</span>
      <span class="txt" id="sideBannerTxt">Estás en SHORT</span>
    </div>

    <!-- ===== MÁS ABAJO: RESTO ===== -->
    <div class="hintUnder" id="ruleText">—</div>

    <div class="kpiGrid">
      <div class="kpi">
        <div class="t">Promedio</div>
        <div class="v" id="kAvg">—</div>
      </div>
      <div class="kpi">
        <div class="t">Liq (aprox.)</div>
        <div class="v" id="kLiq">—</div>
      </div>

      <div class="kpi">
        <div class="t">Lev efectivo</div>
        <div class="v" id="kLevEff">—</div>
      </div>
      <div class="kpi">
        <div class="t">ROE neto (Parcial / Final / SL)</div>
        <div class="v small" id="kRoe">—</div>
      </div>

      <div class="kpi" id="kPL1Card">
        <div class="t">P/L neto @ cierre parcial</div>
        <div class="v" id="kPL1">—</div>
        <div class="subLine">
          <div class="subPill">Cierre: <span id="kClose1Pct">—</span></div>
          <div class="subPill">
            Qty: <span id="kClose1Qty">—</span>
            <span class="copyIco" id="copyQty1" aria-hidden="true">⧉</span>
          </div>
        </div>
      </div>

      <div class="kpi" id="kTP1UsedCard">
        <div class="t">Precio usado</div>
        <div class="v" id="kTP1u">—</div>
        <div class="subLine">
          <div class="subPill">% del precio: <span class="pctTag" id="kTP1pct">—</span></div>
          <div class="subPill">Copiar <span class="copyIco" id="copyTP1" aria-hidden="true">⧉</span></div>
        </div>
      </div>

      <div class="kpi" id="kPL2Card">
        <div class="t">P/L neto @ cierre final</div>
        <div class="v" id="kPL2">—</div>
        <div class="subLine">
          <div class="subPill">Cierre: <span id="kClose2Pct">—</span></div>
          <div class="subPill">
            Qty: <span id="kClose2Qty">—</span>
            <span class="copyIco" id="copyQty2" aria-hidden="true">⧉</span>
          </div>
        </div>
      </div>

      <div class="kpi" id="kTP2UsedCard">
        <div class="t">Precio usado</div>
        <div class="v" id="kTP2u">—</div>
        <div class="subLine">
          <div class="subPill">% del precio: <span class="pctTag" id="kTP2pct">—</span></div>
          <div class="subPill">Copiar <span class="copyIco" id="copyTP2" aria-hidden="true">⧉</span></div>
        </div>
      </div>

      <div class="kpi" id="kPLslCard">
        <div class="t">P/L neto @ SL</div>
        <div class="v" id="kPLsl">—</div>
        <div class="subLine">
          <div class="subPill">Cierre: <span id="kCloseSLPct">100%</span></div>
          <div class="subPill">
            Qty: <span id="kCloseSLQty">—</span>
            <span class="copyIco" id="copyQtySL" aria-hidden="true">⧉</span>
          </div>
        </div>
      </div>

      <div class="kpi" id="kSLUsedCard">
        <div class="t">Precio usado (SL)</div>
        <div class="v" id="kSLu">—</div>
        <div class="subLine">
          <div class="subPill">% del precio: <span class="pctTag" id="kSLpct">—</span></div>
          <div class="subPill">Copiar <span class="copyIco" id="copySL" aria-hidden="true">⧉</span></div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <div class="note">
      (Supuestos Bitunix fijos) P/L y ROE <b>netos</b> con fee ida+vuelta <b>0.06%</b> (peor caso) sobre el <b>NOTIONAL cerrado</b>.
      Liquidación usa MMR fijo <b>1%</b> + fee cierre <b>0.03%</b> (solo para liq).
    </div>
  </div>
</div>

<script>
const BITUNIX = { feeRoundTrip:0.0006, mmr:0.01, liqCloseFee:0.0003 };
const STRATS = {
  ema:{ name:"EMA8", tp1Pct:0.4, slPct:0.4, partialPct:60 },
  bol:{ name:"Bollinger", tp1Pct:0.6, slPct:0.5, partialPct:50 }
};

const $ = (s)=>document.querySelector(s);
const toastEl = $("#toast");
function fmt(x, d=6){ return Number.isFinite(x) ? Number(x).toLocaleString(undefined,{maximumFractionDigits:d}) : "—"; }
function toNum(v){
  if(v==null) return NaN;
  const s = String(v).trim().replace(/\s+/g,'').replace(/,/g,'.');
  const n = parseFloat(s);
  return Number.isFinite(n) ? n : NaN;
}
function setToast(msg){
  toastEl.textContent = msg || "";
  if(msg) setTimeout(()=>{ if(toastEl.textContent===msg) toastEl.textContent=""; }, 1200);
}
async function copyText(text){
  const t = String(text || "").trim();
  if(!t || t==="—") return;
  try{ await navigator.clipboard.writeText(t); setToast("✅ Copiado"); }
  catch(_){
    const ta=document.createElement("textarea");
    ta.value=t; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy");
    document.body.removeChild(ta);
    setToast("✅ Copiado");
  }
}

function qtyFromLeg(price, lev, margin){ return (margin * lev) / price; }
function totals(legs){
  const qtys = legs.map(l => qtyFromLeg(l.price, l.lev, l.margin));
  const Q = qtys.reduce((a,b)=>a+b,0);
  const W = legs.reduce((a,l,i)=>a + l.price*qtys[i],0);
  const M = legs.reduce((a,l)=>a + l.margin,0);
  const avg = (Q>0) ? (W/Q) : NaN;
  const notional = (Q>0 && avg>0) ? (Q*avg) : NaN;
  const levEff = (M>0 && notional>0) ? (notional/M) : NaN;
  return {Q,W,M,avg,notional,levEff, qtys};
}
function liquidation(side, Q, avg, M){
  if(!(Q>0 && avg>0 && M>=0)) return NaN;
  const a = BITUNIX.mmr + BITUNIX.liqCloseFee;
  if(side === "long"){
    const den = Q * (1 - a);
    if(!(den>0)) return NaN;
    return (Q*avg - M) / den;
  }else{
    return (M + Q*avg) / (Q * (1 + a));
  }
}
function pnlGross(side, Q, avg, p){
  if(!(Q>0 && avg>0 && p>0)) return NaN;
  return side === "long" ? (Q*(p-avg)) : (Q*(avg-p));
}
function feeOnClose(notionalClosed){ return (notionalClosed>0) ? notionalClosed * BITUNIX.feeRoundTrip : 0; }
function roe(netPnl, marginTotal){ return (marginTotal>0 && Number.isFinite(netPnl)) ? (netPnl/marginTotal)*100 : NaN; }
function priceFromPct(side, avg, pct, kind){
  const p = pct/100;
  if(!(avg>0 && p>=0)) return NaN;
  if(side==="long") return kind==="tp" ? avg*(1+p) : avg*(1-p);
  return kind==="tp" ? avg*(1-p) : avg*(1+p);
}
function setInvalid(el,on){ el.classList.toggle("invalid",!!on); }
function validateTargets(side, avg, tp1, tp2, sl){
  setInvalid(tp1Input,false); setInvalid(tp2Input,false); setInvalid(slInput,false);
  if(!(avg>0)) return;
  const isLong = side==="long";
  if(Number.isFinite(tp1)) setInvalid(tp1Input, isLong ? (tp1<=avg) : (tp1>=avg));
  if(Number.isFinite(tp2)) setInvalid(tp2Input, isLong ? (tp2<=avg) : (tp2>=avg));
  if(Number.isFinite(sl))  setInvalid(slInput,  isLong ? (sl>=avg)  : (sl<=avg));
}

function pctFromAvg(side, avg, price){
  if(!(avg>0 && price>0)) return NaN;
  if(side === "long") return ((price/avg)-1)*100;
  return ((avg/price)-1)*100;
}
function fmtPct(x){
  if(!Number.isFinite(x)) return "—";
  return `${x.toFixed(2)}%`;
}

const st = { side:"short", strat:"ema", legs:[], editIndex:-1 };

const btnShort=$("#btnShort"), btnLong=$("#btnLong"), btnEma=$("#btnEma"), btnBol=$("#btnBol");
const inPrice=$("#inPrice"), inLev=$("#inLev"), inMargin=$("#inMargin");
const btnAdd=$("#btnAdd"), btnReset=$("#btnReset");
const rowsEl=$("#rows");
const tp1Input=$("#tp1Price"), slInput=$("#slPrice"), tp2Input=$("#tp2Price");
const pillMargin=$("#pillMargin"), pillQty=$("#pillQty"), pillMode=$("#pillMode");
const ruleText=$("#ruleText");

const kAvg=$("#kAvg"), kLiq=$("#kLiq"), kLevEf=$("#kLevEff"), kRoe=$("#kRoe");
const kPL1=$("#kPL1"), kPL2=$("#kPL2"), kPLsl=$("#kPLsl");
const kTP1u=$("#kTP1u"), kTP2u=$("#kTP2u"), kSLu=$("#kSLu");

const kClose1Pct=$("#kClose1Pct"), kClose1Qty=$("#kClose1Qty");
const kClose2Pct=$("#kClose2Pct"), kClose2Qty=$("#kClose2Qty");
const kCloseSLQty=$("#kCloseSLQty");

const kTP1pct=$("#kTP1pct"), kTP2pct=$("#kTP2pct"), kSLpct=$("#kSLpct");
const kPL2Card=$("#kPL2Card"), kTP2UsedCard=$("#kTP2UsedCard");

const copyQty1=$("#copyQty1"), copyQty2=$("#copyQty2"), copyQtySL=$("#copyQtySL");
const copyTP1=$("#copyTP1"), copyTP2=$("#copyTP2"), copySL=$("#copySL");

const sideBanner = $("#sideBanner");
const sideBannerTxt = $("#sideBannerTxt");
const sideBannerIco = $("#sideBannerIco");

function previewLeg(){
  const p=toNum(inPrice.value), L=toNum(inLev.value), m=toNum(inMargin.value);
  return (p>0 && L>0 && m>0) ? {price:p, lev:L, margin:m} : null;
}

function renderTable(committed, preview){
  rowsEl.innerHTML="";
  const all = committed.map((l,i)=>({type:"real",idx:i,leg:l}));
  if(preview) all.push({type:"preview",idx:-1,leg:preview});

  all.forEach(r=>{
    const l=r.leg;
    const q=qtyFromLeg(l.price,l.lev,l.margin);
    const tr=document.createElement("tr");
    if(r.type==="preview") tr.classList.add("preview");

    const actions = r.type==="real"
      ? `<div class="actions">
           <button class="miniBtn" data-edit="${r.idx}">Editar</button>
           <button class="miniBtn" data-del="${r.idx}">Borrar</button>
         </div>`
      : `<span class="muted">Previsualización</span>`;

    tr.innerHTML=`
      <td>${r.type==="real" ? (r.idx+1) : "—"}</td>
      <td class="r">${fmt(l.price,6)}</td>
      <td class="r">${fmt(l.lev,2)}×</td>
      <td class="r col-margin">${fmt(l.margin,2)}</td>
      <td class="r col-qty">${fmt(q,6)}</td>
      <td class="r">${actions}</td>
    `;
    rowsEl.appendChild(tr);
  });
}

rowsEl.addEventListener("click",(e)=>{
  const edit=e.target.getAttribute("data-edit");
  const del=e.target.getAttribute("data-del");

  if(edit!=null){
    const i=parseInt(edit,10);
    const l=st.legs[i];
    st.editIndex=i;
    inPrice.value=String(l.price);
    inLev.value=String(l.lev);
    inMargin.value=String(l.margin);
    btnAdd.textContent="Guardar";
    recalc();
  }
  if(del!=null){
    const i=parseInt(del,10);
    st.legs.splice(i,1);
    if(st.editIndex===i){ st.editIndex=-1; btnAdd.textContent="Añadir entrada"; }
    recalc();
  }
});

function recalc(){
  const prev=previewLeg();
  const used=prev ? st.legs.concat([prev]) : st.legs.slice();
  const t=totals(used);

  pillMargin.textContent = `Margin total: ${t.M>0 ? fmt(t.M,2) : "—"}`;
  pillQty.textContent    = `Qty total: ${t.Q>0 ? fmt(t.Q,6) : "—"}`;
  pillMode.textContent   = prev ? "Modo: PREVIEW (no añadido)" : "Modo: FIJO";
  pillMode.classList.toggle("preview", !!prev);
  pillMode.classList.toggle("ok", !prev);

  renderTable(st.legs, prev);

  const S=STRATS[st.strat];
  ruleText.textContent = `${S.name}: TP ${S.tp1Pct}% | SL ${S.slPct}% | Parcial ${S.partialPct}%`;

  kClose1Pct.textContent="—"; kClose1Qty.textContent="—";
  kClose2Pct.textContent="—"; kClose2Qty.textContent="—";
  kCloseSLQty.textContent="—";
  kTP1pct.textContent="—"; kTP2pct.textContent="—"; kSLpct.textContent="—";

  if(!(t.Q>0 && t.avg>0 && t.M>0)){
    kAvg.textContent="—"; kLiq.textContent="—"; kLevEf.textContent="—"; kRoe.textContent="—";
    kPL1.textContent="—"; kPL2.textContent="—"; kPLsl.textContent="—";
    kTP1u.textContent="—"; kTP2u.textContent="—"; kSLu.textContent="—";
    kPL2Card.style.display=""; kTP2UsedCard.style.display="";
    validateTargets(st.side, NaN, NaN, NaN, NaN);
    return;
  }

  const tp1Ov=toNum(tp1Input.value);
  const slOv =toNum(slInput.value);
  const tp2Ov=toNum(tp2Input.value);

  const tp1Used = Number.isFinite(tp1Ov) ? tp1Ov : priceFromPct(st.side, t.avg, S.tp1Pct, "tp");
  const slUsed  = Number.isFinite(slOv)  ? slOv  : priceFromPct(st.side, t.avg, S.slPct,  "sl");
  const tp2Used = Number.isFinite(tp2Ov) ? tp2Ov : NaN;

  validateTargets(st.side, t.avg, tp1Used, tp2Used, slUsed);

  const liq=liquidation(st.side, t.Q, t.avg, t.M);
  const levEff= (t.M>0 && t.notional>0) ? (t.notional/t.M) : NaN;

  const partialFrac = Math.min(1, Math.max(0, S.partialPct/100));
  const finalFrac = (partialFrac < 1) ? (1 - partialFrac) : 1;

  function netAtPrice(price, closeFrac){
    if(!(price>0) || !(closeFrac>0) || closeFrac>1) return NaN;
    const grossAll=pnlGross(st.side, t.Q, t.avg, price);
    if(!Number.isFinite(grossAll)) return NaN;
    const grossClosed=grossAll*closeFrac;
    const notionalClosed=(t.Q*price)*closeFrac;
    const fee=feeOnClose(notionalClosed);
    return grossClosed-fee;
  }

  const netTP1 = Number.isFinite(tp1Used) ? netAtPrice(tp1Used, partialFrac) : NaN;
  const hasTP2 = Number.isFinite(tp2Used) && (String(tp2Input.value).trim() !== "");
  const netTP2 = hasTP2 ? netAtPrice(tp2Used, finalFrac) : NaN;
  const netSL  = Number.isFinite(slUsed)  ? netAtPrice(slUsed,  1.0) : NaN;

  const roeTP1=roe(netTP1,t.M), roeTP2=roe(netTP2,t.M), roeSL=roe(netSL,t.M);

  kAvg.textContent=fmt(t.avg,6);
  kLiq.textContent=fmt(liq,6);
  kLevEf.textContent=Number.isFinite(levEff)?`${fmt(levEff,2)}×`:"—";
  kRoe.textContent=
    `${Number.isFinite(roeTP1)?fmt(roeTP1,2)+"%":"—"} / `+
    `${Number.isFinite(roeTP2)?fmt(roeTP2,2)+"%":"—"} / `+
    `${Number.isFinite(roeSL)?fmt(roeSL,2)+"%":"—"}`;

  function setPL(el,v){
    if(!Number.isFinite(v)){ el.textContent="—"; el.classList.remove("up","down"); return; }
    el.textContent=`${fmt(v,2)} USDT`;
    el.classList.toggle("up", v>=0);
    el.classList.toggle("down", v<0);
  }
  setPL(kPL1, netTP1);
  setPL(kPL2, netTP2);
  setPL(kPLsl, netSL);

  const qtyTotal = t.Q;

  const qtyClose1 = qtyTotal * partialFrac;
  kClose1Pct.textContent = `${Math.round(partialFrac*100)}%`;
  kClose1Qty.textContent = fmt(qtyClose1,6).replace(/\u00a0/g,'');

  const qtyCloseSL = qtyTotal;
  kCloseSLQty.textContent = fmt(qtyCloseSL,6).replace(/\u00a0/g,'');

  if(hasTP2){
    const qtyClose2 = qtyTotal * finalFrac;
    kClose2Pct.textContent = `${Math.round(finalFrac*100)}%`;
    kClose2Qty.textContent = fmt(qtyClose2,6).replace(/\u00a0/g,'');
  }else{
    kClose2Pct.textContent = "—";
    kClose2Qty.textContent = "—";
  }

  kTP1u.textContent = Number.isFinite(tp1Used) ? fmt(tp1Used,6) : "—";
  kTP1pct.textContent = Number.isFinite(tp1Used) ? fmtPct(pctFromAvg(st.side, t.avg, tp1Used)) : "—";

  kSLu.textContent  = Number.isFinite(slUsed) ? fmt(slUsed,6) : "—";
  kSLpct.textContent = Number.isFinite(slUsed) ? fmtPct(pctFromAvg(st.side, t.avg, slUsed)) : "—";

  if(hasTP2){
    kTP2u.textContent = fmt(tp2Used,6);
    kTP2pct.textContent = fmtPct(pctFromAvg(st.side, t.avg, tp2Used));
  }else{
    kTP2u.textContent = "—";
    kTP2pct.textContent = "—";
  }

  kPL2Card.style.display = hasTP2 ? "" : "none";
  kTP2UsedCard.style.display = hasTP2 ? "" : "none";
}

function applySideBanner(side){
  const isShort = side === "short";
  sideBanner.classList.toggle("short", isShort);
  sideBanner.classList.toggle("long", !isShort);
  sideBannerIco.textContent = isShort ? "⚠️" : "✅";
  sideBannerTxt.textContent = isShort ? "Estás en SHORT" : "Estás en LONG";
}

function setSide(side){
  st.side=side;
  btnShort.classList.toggle("on", side==="short");
  btnLong.classList.toggle("on", side==="long");
  applySideBanner(side);
  recalc();
}
function setStrat(s){
  st.strat=s;
  btnEma.classList.toggle("on", s==="ema");
  btnBol.classList.toggle("on", s==="bol");
  recalc();
}

btnShort.addEventListener("click",()=>setSide("short"));
btnLong.addEventListener("click",()=>setSide("long"));
btnEma.addEventListener("click",()=>setStrat("ema"));
btnBol.addEventListener("click",()=>setStrat("bol"));

btnAdd.addEventListener("click",()=>{
  const p=toNum(inPrice.value), L=toNum(inLev.value), m=toNum(inMargin.value);
  if(!(p>0 && L>0 && m>0)) return alert("Completa Entrada, Lev y Margen (>0).");
  const leg={price:p, lev:L, margin:m};

  if(st.editIndex>=0){
    st.legs[st.editIndex]=leg;
    st.editIndex=-1;
    btnAdd.textContent="Añadir entrada";
  }else{
    st.legs.push(leg);
  }
  inPrice.value="";
  recalc();
});

btnReset.addEventListener("click",()=>{
  st.legs=[]; st.editIndex=-1; btnAdd.textContent="Añadir entrada";
  inPrice.value=""; inLev.value=""; inMargin.value="";
  tp1Input.value=""; slInput.value=""; tp2Input.value="";
  setToast("");
  recalc();
});

[inPrice,inLev,inMargin,tp1Input,slInput,tp2Input].forEach(el=> el.addEventListener("input", recalc));

copyQty1.addEventListener("click", ()=> copyText($("#kClose1Qty").textContent));
copyQty2.addEventListener("click", ()=> copyText($("#kClose2Qty").textContent));
copyQtySL.addEventListener("click", ()=> copyText($("#kCloseSLQty").textContent));

copyTP1.addEventListener("click", ()=> copyText($("#kTP1u").textContent));
copyTP2.addEventListener("click", ()=> copyText($("#kTP2u").textContent));
copySL.addEventListener("click", ()=> copyText($("#kSLu").textContent));

setSide("short");
setStrat("ema");
recalc();
</script>
</body>
</html>
