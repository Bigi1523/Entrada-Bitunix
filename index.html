<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Bitunix — Entradas → Promedio / Liq / TP1-TP2</title>
  <style>
    :root{
      --bg1:#0b1220; --bg2:#0f172a;
      --panel: rgba(17,24,39,.78);
      --card: rgba(9,14,26,.78);
      --border: rgba(148,163,184,.14);
      --text:#e5e7eb; --muted:#94a3b8;

      --cyan:#22d3ee;
      --blue:#0ea5e9;

      --green:#16a34a;      --green2:#22c55e;
      --red:#991b1b;        --red2:#ef4444;

      --shadow: 0 10px 35px rgba(0,0,0,.35);
      --r:18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Inter, Roboto, Ubuntu, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 700px at 30% 0%, rgba(34,211,238,.12), transparent 55%),
                  radial-gradient(900px 600px at 80% 30%, rgba(14,165,233,.10), transparent 60%),
                  linear-gradient(160deg, var(--bg1), var(--bg2));
      min-height: 100vh;
    }

    .wrap{
      max-width: 920px;
      margin: 0 auto;
      padding: 14px 14px 28px;
      padding-bottom: max(28px, env(safe-area-inset-bottom));
    }

    .title{
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 18px;
      margin: 4px 0 10px;
      opacity: .98;
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 12px;
      backdrop-filter: blur(10px);
    }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .spacer{ height: 10px; }

    .grid2{ display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
    .grid3{ display:grid; gap:10px; grid-template-columns: 1fr 1fr 1fr; }
    .grid4{ display:grid; gap:10px; grid-template-columns: 1fr 1fr 1fr 1fr; }

    @media (max-width: 820px){
      .grid3{ grid-template-columns: 1fr 1fr; }
      .grid4{ grid-template-columns: 1fr 1fr; }
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px;
    }

    input{
      width:100%;
      font:inherit;
      color:var(--text);
      background: rgba(6,10,18,.78);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 12px;
      outline:none;
    }
    input:focus{
      border-color: rgba(34,211,238,.50);
      box-shadow: 0 0 0 3px rgba(34,211,238,.12);
    }
    input::placeholder{ color: rgba(148,163,184,.65); }

    .btn{
      font:inherit;
      border: 1px solid var(--border);
      background: rgba(12,18,34,.70);
      color: var(--text);
      border-radius: 14px;
      padding: 11px 12px;
      cursor:pointer;
      user-select:none;
      transition: transform .04s ease, filter .12s ease, background .12s ease;
    }
    .btn:active{ transform: scale(.99); }
    .btn.primary{
      border: none;
      background: linear-gradient(135deg, var(--cyan), var(--blue));
      color: #041018;
      font-weight: 800;
    }

    .seg{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .seg button{
      width:100%;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(12,18,34,.55);
      color: var(--text);
      cursor:pointer;
      font-weight: 750;
      letter-spacing: .2px;
    }

    /* Short/Long colors */
    .seg .short.active{
      background: linear-gradient(180deg, rgba(239,68,68,.18), rgba(153,27,27,.20));
      border-color: rgba(239,68,68,.40);
      box-shadow: 0 0 0 3px rgba(239,68,68,.10) inset;
    }
    .seg .long.active{
      background: linear-gradient(180deg, rgba(34,197,94,.18), rgba(22,163,74,.20));
      border-color: rgba(34,197,94,.40);
      box-shadow: 0 0 0 3px rgba(34,197,94,.10) inset;
    }

    .pillRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 8px;
    }
    .pill{
      font-size: 13px;
      color: rgba(229,231,235,.90);
      background: rgba(0,0,0,.18);
      border: 1px solid var(--border);
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    table{
      width:100%;
      border-collapse: collapse;
      margin-top: 8px;
      overflow:hidden;
      border-radius: 14px;
    }
    th, td{
      padding: 10px 8px;
      border-bottom: 1px solid rgba(148,163,184,.10);
      font-size: 13px;
    }
    th{ color: var(--muted); font-weight: 650; text-align:left; }
    td.r, th.r{ text-align:right; }
    tr:last-child td{ border-bottom: 0; }
    tr.ghost td{
      opacity: .70;
      font-style: italic;
    }

    .actions{
      display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;
    }
    .mini{
      padding: 7px 10px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 750;
    }

    .kpis{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr 1fr;
      margin-top: 10px;
    }
    @media (min-width: 820px){
      .kpis{ grid-template-columns: 1fr 1fr 1fr; }
    }

    .kpi{
      background: rgba(6,10,18,.52);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
    }
    .kpi .t{ font-size: 12px; color: var(--muted); }
    .kpi .v{ font-size: 18px; font-weight: 900; margin-top: 6px; letter-spacing:.2px; }

    .up{ color: var(--green2); }
    .down{ color: var(--red2); }

    .note{
      color: rgba(148,163,184,.90);
      font-size: 12.5px;
      margin-top: 10px;
      line-height: 1.25rem;
      opacity: .95;
    }

    .subtleLine{
      height:1px;
      background: rgba(148,163,184,.10);
      margin: 10px 0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">Bitunix — Entradas → Promedio / Liq / TP1-TP2 (iPhone)</div>

    <div class="panel">
      <!-- LADO -->
      <label>Lado</label>
      <div class="seg" role="group" aria-label="Lado">
        <button id="btnShort" class="short active">Short</button>
        <button id="btnLong" class="long">Long</button>
      </div>

      <div class="spacer"></div>

      <!-- ESTRATEGIA -->
      <label>Estrategia</label>
      <div class="seg" role="group" aria-label="Estrategia">
        <button id="btnEma" class="active">EMA8</button>
        <button id="btnBol">Bollinger</button>
      </div>

      <div class="spacer"></div>

      <!-- ENTRADA -->
      <div class="grid3">
        <div>
          <label>Entrada</label>
          <input id="inPrice" inputmode="decimal" placeholder="Ej: 223.59" />
        </div>
        <div>
          <label>Lev (x)</label>
          <input id="inLev" inputmode="decimal" placeholder="30" />
        </div>
        <div>
          <label>Margen</label>
          <input id="inMargin" inputmode="decimal" placeholder="50" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="btnAdd" class="btn primary">Añadir entrada</button>
        <button id="btnReset" class="btn">Reset</button>
        <span id="editHint" style="color:var(--muted); font-size:12.5px;"></span>
      </div>

      <div class="pillRow">
        <div class="pill" id="pillMargin">Margin total: —</div>
        <div class="pill" id="pillQty">Qty total: —</div>
        <div class="pill" id="pillMode">Modo: PREVIEW</div>
      </div>

      <!-- TABLA -->
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th class="r">Precio</th>
            <th class="r">Lev</th>
            <th class="r">Margen</th>
            <th class="r">Qty</th>
            <th class="r">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="subtleLine"></div>

      <!-- TP/SL compactos -->
      <div class="grid3">
        <div>
          <label>TP1 (precio, opcional)</label>
          <input id="tp1Price" inputmode="decimal" placeholder="vacío = usa % estrategia" />
        </div>
        <div>
          <label>SL (precio, opcional)</label>
          <input id="slPrice" inputmode="decimal" placeholder="vacío = usa % estrategia" />
        </div>
        <div>
          <label>TP2 (precio, opcional)</label>
          <input id="tp2Price" inputmode="decimal" placeholder="cierre TOTAL 100%" />
        </div>
      </div>

      <div class="note" id="ruleLine">—</div>

      <!-- KPIs -->
      <div class="kpis">
        <div class="kpi">
          <div class="t">Promedio</div>
          <div class="v" id="kAvg">—</div>
        </div>
        <div class="kpi">
          <div class="t">Liq (aprox.)</div>
          <div class="v" id="kLiq">—</div>
        </div>
        <div class="kpi">
          <div class="t">Lev efectivo</div>
          <div class="v" id="kLevEff">—</div>
        </div>

        <div class="kpi">
          <div class="t">ROE neto (TP1 / TP2 / SL)</div>
          <div class="v" id="kRoe">—</div>
        </div>
        <div class="kpi">
          <div class="t">P/L neto @ TP1 (parcial)</div>
          <div class="v" id="kPl1">—</div>
        </div>
        <div class="kpi">
          <div class="t">P/L neto @ TP2 (final)</div>
          <div class="v" id="kPl2">—</div>
        </div>

        <div class="kpi">
          <div class="t">P/L neto @ SL</div>
          <div class="v" id="kPlSl">—</div>
        </div>
        <div class="kpi">
          <div class="t">TP1 usado</div>
          <div class="v" id="kTP1u">—</div>
        </div>
        <div class="kpi">
          <div class="t">TP2 usado</div>
          <div class="v" id="kTP2u">—</div>
        </div>
      </div>

      <div class="note">
        Supuestos Bitunix (fijos): <b>fee ida+vuelta 0.06%</b> (peor caso) sobre <b>NOTIONAL cerrado</b>.
        Liquidación usa <b>MMR 1%</b> + <b>fee cierre 0.03%</b> (aprox).<br/>
        Nota: esto es una aproximación razonable; tiers/fees reales pueden variar.
      </div>
    </div>
  </div>

<script>
  // =========================
  // CONFIG FIJA "Bitunix"
  // =========================
  const BITUNIX = {
    FEE_ROUND_TRIP_PCT: 0.06,  // % sobre notional cerrado (peor caso, ida+vuelta)
    MMR_PCT: 1.0,              // % para liq aprox
    CLOSE_FEE_PCT: 0.03,       // % adicional solo para liq aprox
  };

  // Estrategias (por defecto)
  const STRATS = {
    ema: { name: "EMA8", tp1Pct: 0.4, slPct: 0.4, partialPct: 60 },
    bol: { name: "Bollinger", tp1Pct: 0.6, slPct: 0.5, partialPct: 50 },
  };

  // =========================
  // Estado
  // =========================
  const st = {
    side: "short",       // short | long
    strat: "ema",        // ema | bol
    legs: [],            // {price, lev, margin}
    editIndex: -1,       // -1 none
  };

  // =========================
  // Helpers
  // =========================
  const $ = (id) => document.getElementById(id);

  function toNum(v){
    if(v == null) return NaN;
    const s = String(v).trim().replace(/\s+/g,'').replace(/,/g,'.');
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : NaN;
  }

  function fmt(x, d=6){
    if(!Number.isFinite(x)) return "—";
    const dd = Math.max(0, Math.min(8, d));
    return Number(x).toLocaleString(undefined, {
      maximumFractionDigits: dd,
      minimumFractionDigits: Math.min(2, dd)
    });
  }

  function near(a,b,eps=1e-10){
    return Number.isFinite(a) && Number.isFinite(b) && Math.abs(a-b) <= eps*Math.max(1, Math.abs(a), Math.abs(b));
  }

  function qtyFromLeg(price, lev, margin){
    return (margin * lev) / price;
  }

  function totals(legs){
    const qtys = legs.map(l => qtyFromLeg(l.price, l.lev, l.margin));
    const Q = qtys.reduce((a,b)=>a+b,0);
    const W = legs.reduce((a,l,i)=> a + l.price*qtys[i], 0);
    const M = legs.reduce((a,l)=> a + l.margin, 0);
    const avg = (Q>0) ? W/Q : NaN;
    const notional = (Q>0 && avg>0) ? Q*avg : NaN;
    const levEff = (M>0 && Number.isFinite(notional)) ? notional/M : NaN;
    return {Q, W, M, avg, notional, levEff, qtys};
  }

  // Net PnL: incluye fee ida+vuelta sobre notional cerrado
  function pnlNet(side, Q_close, avg, exitPrice){
    if(!(Q_close>0 && avg>0 && exitPrice>0)) return NaN;

    // PnL bruto
    const gross = (side==="long")
      ? Q_close * (exitPrice - avg)
      : Q_close * (avg - exitPrice);

    // Fee peor caso: round-trip % sobre notional cerrado
    const feeRt = (BITUNIX.FEE_ROUND_TRIP_PCT/100);
    const notionalClosed = Q_close * exitPrice; // aprox (puede ser avg o exit; usamos exit)
    const fees = notionalClosed * feeRt;

    return gross - fees;
  }

  function roePct(pnl, marginTotal){
    if(!(marginTotal>0) || !Number.isFinite(pnl)) return NaN;
    return (pnl / marginTotal) * 100;
  }

  // Liq aprox usando:
  // a = MMR + fee cierre  (ambos en fracción)
  // LONG: (Q*avg - M) / (Q*(1-a))
  // SHORT: (M + Q*avg) / (Q*(1+a))
  function liqApprox(side, Q, avg, M){
    if(!(Q>0 && avg>0 && M>=0)) return NaN;
    const a = (BITUNIX.MMR_PCT + BITUNIX.CLOSE_FEE_PCT)/100; // fracción

    if(side==="long"){
      const den = Q*(1 - a);
      if(!(den>0)) return NaN;
      return (Q*avg - M) / den;
    }else{
      const den = Q*(1 + a);
      if(!(den>0)) return NaN;
      return (M + Q*avg) / den;
    }
  }

  function priceFromPct(entry, pct, side, kind){
    // kind: "tp" o "sl" (solo para claridad)
    // pct es % de precio (ej 0.4 => 0.4%)
    const f = (pct/100);
    if(!(entry>0 && f>=0)) return NaN;

    if(side==="long"){
      return (kind==="tp") ? entry*(1+f) : entry*(1-f);
    }else{
      return (kind==="tp") ? entry*(1-f) : entry*(1+f);
    }
  }

  function getGhostLeg(){
    const p = toNum($("inPrice").value);
    const L = toNum($("inLev").value);
    const m = toNum($("inMargin").value);
    if(p>0 && L>0 && m>0) return {price:p, lev:L, margin:m};
    return null;
  }

  function setActiveButtons(){
    $("btnShort").classList.toggle("active", st.side==="short");
    $("btnLong").classList.toggle("active", st.side==="long");

    $("btnEma").classList.toggle("active", st.strat==="ema");
    $("btnBol").classList.toggle("active", st.strat==="bol");
  }

  // =========================
  // Render Tabla
  // =========================
  function renderTable(){
    const tb = $("tbody");
    tb.innerHTML = "";

    st.legs.forEach((l,i)=>{
      const q = qtyFromLeg(l.price, l.lev, l.margin);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td class="r">${fmt(l.price,6)}</td>
        <td class="r">${fmt(l.lev,2)}×</td>
        <td class="r">${fmt(l.margin,2)}</td>
        <td class="r">${fmt(q,6)}</td>
        <td class="r">
          <div class="actions">
            <button class="btn mini" data-ed="${i}">Editar</button>
            <button class="btn mini" data-del="${i}">Borrar</button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    });

    const ghost = getGhostLeg();
    if(ghost){
      const q = qtyFromLeg(ghost.price, ghost.lev, ghost.margin);
      const tr = document.createElement("tr");
      tr.className = "ghost";
      tr.innerHTML = `
        <td>—</td>
        <td class="r">${fmt(ghost.price,6)}</td>
        <td class="r">${fmt(ghost.lev,2)}×</td>
        <td class="r">${fmt(ghost.margin,2)}</td>
        <td class="r">${fmt(q,6)}</td>
        <td class="r" style="color:rgba(148,163,184,.85)">Preview</td>
      `;
      tb.appendChild(tr);
    }
  }

  // =========================
  // Cálculo principal
  // =========================
  function recalc(){
    setActiveButtons();

    // Legs + ghost
    const ghost = getGhostLeg();
    const legsUse = ghost ? st.legs.concat([ghost]) : st.legs.slice();

    const t = totals(legsUse);

    $("pillMargin").textContent = `Margin total: ${t.M>0 ? fmt(t.M,2) : "—"}`;
    $("pillQty").textContent = `Qty total: ${t.Q>0 ? fmt(t.Q,6) : "—"}`;
    $("pillMode").textContent = `Modo: ${ghost ? "PREVIEW" : "FIJO"}`;

    renderTable();

    // Regla estrategia
    const S = STRATS[st.strat];
    $("ruleLine").textContent = `${S.name}: TP1 ${S.tp1Pct}% | SL ${S.slPct}% | Parcial ${S.partialPct}%`;

    // KPIs base
    $("kAvg").textContent = fmt(t.avg,6);
    $("kLevEff").textContent = (t.levEff>0) ? `${fmt(t.levEff,2)}×` : "—";
    $("kLiq").textContent = fmt(liqApprox(st.side, t.Q, t.avg, t.M), 6);

    // Si no hay posición, limpia outputs
    if(!(t.Q>0 && t.avg>0 && t.M>0)){
      $("kRoe").textContent = "—";
      $("kPl1").textContent = "—";
      $("kPl2").textContent = "—";
      $("kPlSl").textContent = "—";
      $("kTP1u").textContent = "—";
      $("kTP2u").textContent = "—";
      return;
    }

    // TP1/SL/TP2: precio override o % estrategia
    const tp1O = toNum($("tp1Price").value);
    const slO  = toNum($("slPrice").value);
    const tp2O = toNum($("tp2Price").value);

    const tp1Used = (tp1O>0) ? tp1O : priceFromPct(t.avg, S.tp1Pct, st.side, "tp");
    const slUsed  = (slO>0)  ? slO  : priceFromPct(t.avg, S.slPct,  st.side, "sl");
    const tp2Used = (tp2O>0) ? tp2O : NaN; // TP2 solo si lo pones

    // Cantidades a cerrar:
    // - TP1: parcial S.partialPct (a menos que TP2=TP1 => consideramos cierre total)
    // - TP2: cierre TOTAL 100% (de lo que quede, o todo si tp1=tp2)
    const partialFrac = S.partialPct/100;

    const tp2EqualsTp1 = (tp2Used>0) && near(tp2Used, tp1Used, 1e-8);

    const Q_total = t.Q;
    let Q_tp1 = Q_total * partialFrac;
    let Q_rem = Q_total - Q_tp1;

    // Si TP2 == TP1, interpretamos cierre total en ese mismo precio (no hay “resto”)
    if(tp2EqualsTp1){
      Q_tp1 = Q_total;  // TP1 pasa a ser total
      Q_rem = 0;
    }

    // PnL netos
    const pl_tp1 = pnlNet(st.side, Q_tp1, t.avg, tp1Used);
    const pl_sl  = pnlNet(st.side, Q_total, t.avg, slUsed);

    // TP2: cierre total (si existe)
    // Si TP2 existe y no es igual TP1:
    //  - calculamos el pnl final del remanente a TP2
    //  - (no sumamos TP1 aquí; este panel muestra “final”, no “total acumulado”)
    // Si quieres que “TP2 (final)” muestre total acumulado (TP1+TP2), dímelo y lo cambio.
    let pl_tp2 = NaN;
    if(tp2Used>0){
      if(tp2EqualsTp1){
        pl_tp2 = pl_tp1; // mismo cierre total
      }else{
        pl_tp2 = pnlNet(st.side, Q_rem, t.avg, tp2Used);
      }
    }

    // ROE netos
    const roe1 = roePct(pl_tp1, t.M);
    const roe2 = roePct(pl_tp2, t.M);
    const roesl = roePct(pl_sl, t.M);

    // UI
    $("kTP1u").textContent = fmt(tp1Used,6);
    $("kTP2u").textContent = (tp2Used>0) ? fmt(tp2Used,6) : "—";

    $("kPl1").innerHTML = Number.isFinite(pl_tp1)
      ? `<span class="${pl_tp1>=0?'up':'down'}">${fmt(pl_tp1,2)} USDT</span>`
      : "—";

    $("kPl2").innerHTML = Number.isFinite(pl_tp2)
      ? `<span class="${pl_tp2>=0?'up':'down'}">${fmt(pl_tp2,2)} USDT</span>`
      : "—";

    $("kPlSl").innerHTML = Number.isFinite(pl_sl)
      ? `<span class="${pl_sl>=0?'up':'down'}">${fmt(pl_sl,2)} USDT</span>`
      : "—";

    const roeStr = `${fmt(roe1,2)}% / ${Number.isFinite(roe2)? fmt(roe2,2)+'%':'—'} / ${fmt(roesl,2)}%`;
    $("kRoe").textContent = roeStr;

    // Hint edición
    if(st.editIndex>=0){
      $("editHint").textContent = `Editando fila ${st.editIndex+1}`;
      $("btnAdd").textContent = "Guardar";
    }else{
      $("editHint").textContent = "";
      $("btnAdd").textContent = "Añadir entrada";
    }
  }

  // =========================
  // Eventos
  // =========================
  $("btnShort").addEventListener("click", ()=>{
    st.side = "short";
    recalc();
  });
  $("btnLong").addEventListener("click", ()=>{
    st.side = "long";
    recalc();
  });

  $("btnEma").addEventListener("click", ()=>{
    st.strat = "ema";
    recalc();
  });
  $("btnBol").addEventListener("click", ()=>{
    st.strat = "bol";
    recalc();
  });

  // Preview live al tipear
  ["inPrice","inLev","inMargin","tp1Price","slPrice","tp2Price"].forEach(id=>{
    $(id).addEventListener("input", recalc);
  });

  // Añadir / Guardar
  $("btnAdd").addEventListener("click", ()=>{
    const p = toNum($("inPrice").value);
    const L = toNum($("inLev").value);
    const m = toNum($("inMargin").value);

    if(!(p>0 && L>0 && m>0)){
      alert("Completa Entrada, Lev y Margen (todos > 0).");
      return;
    }

    if(st.editIndex>=0){
      st.legs[st.editIndex] = {price:p, lev:L, margin:m};
      st.editIndex = -1;
    }else{
      st.legs.push({price:p, lev:L, margin:m});
    }

    // Limpia inputs para la próxima prueba (como pediste)
    $("inPrice").value = "";
    // si quieres también limpiar lev/margen, descomenta:
    // $("inLev").value = "";
    // $("inMargin").value = "";

    recalc();
  });

  $("btnReset").addEventListener("click", ()=>{
    st.legs = [];
    st.editIndex = -1;
    recalc();
  });

  // Click tabla: editar/borrar
  $("tbody").addEventListener("click", (e)=>{
    const ed = e.target.getAttribute("data-ed");
    const del = e.target.getAttribute("data-del");

    if(ed !== null){
      const i = parseInt(ed,10);
      const l = st.legs[i];
      $("inPrice").value = l.price;
      $("inLev").value = l.lev;
      $("inMargin").value = l.margin;
      st.editIndex = i;
      recalc();
    }

    if(del !== null){
      const i = parseInt(del,10);
      st.legs.splice(i,1);
      if(st.editIndex === i) st.editIndex = -1;
      if(st.editIndex > i) st.editIndex -= 1;
      recalc();
    }
  });

  // Init
  recalc();
</script>
</body>
</html>
